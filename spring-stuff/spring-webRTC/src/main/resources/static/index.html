<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>WebRTC JS-Client</title>
    <style>
        video { width: 45%; margin: 0.5rem; background: #000; }
        body { font-family: system-ui, sans-serif; }
    </style>
</head>
<body>
    <h1>WebRTC JS-Client</h1>
    <input id="room" placeholder="roomId">
    <button id="join">Join</button>
    <div>
        <video id="local" autoplay muted playsinline></video>
        <video id="remote" autoplay playsinline></video>
    </div>
    <script>
        const webSocket = new WebSocket("ws://localhost:8080/ws")
        const webRTC = new RTCPeerConnection({
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" },
                { urls: "stun:stun1.l.google.com:19302" }
            ]
        })
        const roomInput = document.getElementById("room")
        const connectButton = document.getElementById("join")
        const localVideo = document.getElementById("local")
        const remoteVideo = document.getElementById("remote")
        let room

        webSocket.onopen = () => console.log("websocket open")
        webSocket.onmessage = async ({data}) => {
            const message = JSON.parse(data)

            if(message.type === "answer" && message.sdp) {
                await webRTC.setRemoteDescription({type: "answer", sdp: message.sdp})
            } else if(message.type === "offer" && msg.sdp) {
                await webRTC.setRemoteDescription({type:"offer", sdp: message.sdp})
                const answer = await webRTC.createAnswer()
                await webRTC.setLocalDescription(answer)
                webSocket.send(JSON.stringify({type: "answer", room, sdp: answer.sdp, sdpType: "answer"}))
            } else if (message.type === "ice" && message.ice?.candidate) {
                try {
                    await webRTC.addIceCandidate(message.ice)
                } catch (e) {
                    console.error("Error adding received ice candidate", e)
                }
            }
        }

        webRTC.ontrack = (event) => {
            remoteVideo.srcObject = event.streams[0]
        }

        webRTC.onicecandidate = (candidate) => {
            if (candidate) {
                webSocket.send(JSON.stringify({
                    type: "ice",
                    room,
                    ice: candidate.candidate
                }))
            }
        }

        connectButton.onclick = async() => {
            room = roomInput.value || "default-room"
            webSocket.send(JSON.stringify({
                type: "join",
                room
            }))

            const stream = await navigator.mediaDevices.getUserMedia({video: true, audio: true})
            stream.getTracks().forEach(track => webRTC.addTrack(track, stream))
            localVideo.srcObject = stream

            const offer = await webRTC.createOffer()
            await webRTC.setLocalDescription(offer)
            webSocket.send(JSON.stringify({
                type: "offer",
                room,
                sdp: offer.sdp,
                sdpType: "offer"
            }))
        }
    </script>
</body>
</html>